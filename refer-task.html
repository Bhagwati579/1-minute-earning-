<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EarnGati Referral Task Panel</title>
  <style>
    body { font-family: Arial; background: #000; color: white; padding: 20px; }
    h2 { color: #ff4444; }
    input, textarea { width: 100%%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none; }
    button { background: #ff0000; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    .task-card { background: #111; padding: 15px; margin-bottom: 10px; border-radius: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>ðŸ“‹ Welcome to EarnGati Task Panel</h2>
  <p id="referText"></p>

  <div id="taskContainer"></div>

  <div id="submitForm" class="hidden">
    <h3>âœ… Submit Task Completion</h3>
    <input type="text" id="yourName" placeholder="Your Name" required />
    <input type="text" id="yourUPI" placeholder="Your UPI ID (for payout)" required />
    <button onclick="submitTask()">Submit Completion</button>
    <p id="successMsg" style="color: lightgreen;"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { firebaseConfig } from "./refer-firebase.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const queryParams = new URLSearchParams(window.location.search);
    const refID = queryParams.get("ref") || "unknown";
    document.getElementById("referText").innerText = "Referral ID: " + refID;

    const taskContainer = document.getElementById("taskContainer");
    const submitForm = document.getElementById("submitForm");

    const tasksRef = ref(db, "tasks/");
    onValue(tasksRef, (snapshot) => {
      taskContainer.innerHTML = "";
      snapshot.forEach(child => {
        const task = child.val();
        if (!task.paid && !task.fromClient) {
          const div = document.createElement("div");
          div.className = "task-card";
          div.innerHTML = `
            <b>Task:</b> ${task.task}<br />
            <button onclick="showForm()">Complete Task</button>
          `;
          taskContainer.appendChild(div);
        }
      });
    });

    window.showForm = function () {
      submitForm.classList.remove("hidden");
    }

    window.submitTask = function () {
      const name = document.getElementById("yourName").value;
      const upi = document.getElementById("yourUPI").value;

      push(ref(db, "referral_submissions/"), {
        name,
        upi,
        referralId: refID,
        timestamp: Date.now(),
        paid: false
      }).then(() => {
        document.getElementById("successMsg").innerText = "âœ… Task submitted successfully! Wait for admin payout.";
        submitForm.classList.add("hidden");
      });
    }
  </script>
</body>
</html>
